const translations = {
    en: {
        home: "Home",
        collection: "Store",
        about: "About Us",
        contact: "Contact",
        hero_title: "penfumes by liad",
        about_title: "Parfume a by Liad",
        about_intro: "This isn't just another perfume – it's an experience.",
        about_goal: "We aren't just another store that sells perfumes. Our goal is simple: to make sure you're never disappointed with the perfume you buy.",
        about_reason: "At <strong>Parfume a by Liad</strong>, we know how frustrating it is to buy an expensive perfume and then realize it doesn't last, doesn't sit well on your skin, or simply isn't \"it\". That's exactly why we're here.",
        about_q1: "✨ Unsure which perfume to choose?",
        about_q2: "✨ Not certain if the scent is right for you?",
        about_solution: "With us, you can purchase small glass bottles of 2 / 3 / 5 ml of any perfume you desire, to truly test it – see how long it remains on the skin, how it develops throughout the day, and how it feels to you.",
        about_full_bottle: "Only when you're certain of the scent and sure it's worth it – you move forward to the full bottle.",
        about_selection: "At <strong>Parfume a by Liad</strong>, every scent is carefully selected to project luxury, presence, and style, leaving an unforgettable impression.",
        about_b1: "✨ High-quality and long-lasting fragrances",
        about_b2: "✨ A smart and disappointment-free shopping experience",
        about_b3: "✨ Luxurious design – also perfect as a gift",
        about_footer: "Because it's not just a perfume – it's your identity in a bottle.",
        lang_btn: "HE",

        // Shop Translations
        collection_title: "Shop",
        prod_1_name: "Midnight Rose",
        prod_1_desc: "A bold blend of dark rose and oud.",
        prod_1_price: "₪250",
        prod_2_name: "Golden Amber",
        prod_2_desc: "Warm amber with hints of vanilla.",
        prod_2_price: "₪280",
        prod_3_name: "Ocean Mist",
        prod_3_desc: "Fresh aquatic notes with citrus.",
        prod_3_price: "₪220",
        add_to_cart: "Add to Cart",

        // Cart Translations
        cart_title: "Your Cart",
        empty_cart: "Your cart is empty.",
        total: "Total:",
        checkout: "Checkout",
        pickup: "Self Pickup (Free)",
        shipping: "Delivery (+₪60)",
        footer_copy: "&copy; 2026 Penfumes by Liad. All Rights Reserved.",

        // Auth Translations
        login_signup: "Login / Sign Up",
        login_title: "Login",
        login_btn: "Login",
        need_account: "Need an account? Sign Up",
        forgot_password: "Forgot Password?",
        signup_title: "Sign Up",
        signup_btn: "Sign Up",
        have_account: "Already have an account? Login",
        forgot_password_title: "Reset Password",
        enter_reset_link_msg: "Enter your email to receive a link to reset your password.",
        send_link: "Send Link",
        new_password_title: "New Password",
        reset_password_btn: "Reset Password",
        logout: "Logout",
        hello: "Hello"
    },
    he: {
        home: "בית",
        collection: "חנות",
        about: "עלינו",
        contact: "צור קשר",
        hero_title: "penfumes by liad",
        about_title: "Parfume a by Liad",
        about_intro: "זה לא עוד בושם – זו חוויה.",
        about_goal: "אנחנו לא סתם עוד חנות שמוכרת בשמים. המטרה שלנו היא דבר אחד פשוט: שלא תתאכזב מהבושם שאתה קונה.",
        about_reason: "ב־<strong>Parfume a by Liad</strong> אנחנו יודעים כמה זה מבאס לקנות בושם יקר ואז לגלות שהוא לא מחזיק, לא יושב טוב על העור, או שפשוט זה לא זה. בדיוק בגלל זה אנחנו כאן.",
        about_q1: "✨ מתלבט איזה בושם לבחור?",
        about_q2: "✨ לא בטוח אם הריח מתאים לך?",
        about_solution: "אצלנו תוכל לרכוש בקבוקי זכוכית קטנים של 2 / 3 / 5 מ״ל מכל בושם שתרצה, לבדוק אותו באמת – לראות כמה זמן הוא נשאר על העור, איך הוא מתפתח במהלך היום, ואיך הוא מרגיש לך.",
        about_full_bottle: "ורק כשאתה סגור על הריח ובטוח שהוא שווה לך – אתה מתקדם לבקבוק המלא.",
        about_selection: "ב־<strong>Parfume a by Liad</strong> כל ניחוח נבחר בקפידה כדי לשדר יוקרה, נוכחות וסטייל, ולהשאיר רושם שאי אפשר לשכוח.",
        about_b1: "✨ ניחוחות איכותיים ועמידים",
        about_b2: "✨ חוויית קנייה חכמה וללא אכזבות",
        about_b3: "✨ עיצוב יוקרתי – מושלם גם כמתנה",
        about_footer: "כי זה לא סתם בושם – זו הזהות שלך בבקבוק.",
        lang_btn: "EN",

        // Shop Translations
        collection_title: "חנות",
        prod_1_name: "ורד חצות",
        prod_1_desc: "שילוב נועז של ורד כהה ואוד.",
        prod_1_price: "₪250",
        prod_2_name: "ענבר זהוב",
        prod_2_desc: "ענבר חמים עם נגיעות וניל.",
        prod_2_price: "₪280",
        prod_3_name: "ערפל האוקיינוס",
        prod_3_desc: "תווים ימיים רעננים עם הדרים.",
        prod_3_price: "₪220",
        add_to_cart: "הוסף לסל",

        // Cart Translations
        cart_title: "העגלה שלך",
        empty_cart: "העגלה שלך ריקה.",
        total: "סה\"כ:",
        checkout: "לקופה",
        pickup: "איסוף עצמי (חינם)",
        shipping: "משלוח (+₪60)",
        footer_copy: "&copy; 2026 Penfumes by Liad. כל הזכויות שמורות.",

        // Auth Translations
        login_signup: "התחבר / הרשם",
        login_title: "התחברות",
        login_btn: "התחבר",
        need_account: "צריך חשבון? הרשם",
        forgot_password: "שכחתי סיסמה",
        signup_title: "הרשמה",
        signup_btn: "הרשם",
        have_account: "כבר יש לך חשבון? התחבר",
        forgot_password_title: "איפוס סיסמה",
        enter_reset_link_msg: "הזן את המייל שלך לקבלת קישור לאיפוס סיסמה.",
        send_link: "שלח קישור",
        new_password_title: "סיסמה חדשה",
        reset_password_btn: "אפס סיסמה",
        logout: "התנתק",
        hello: "שלום"
    }
};

let currentLang = 'en';

const updateLanguage = () => {
    const elements = document.querySelectorAll('[data-i18n]');
    elements.forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[currentLang][key]) {
            el.innerHTML = translations[currentLang][key];
        }
    });

    // Update switch button text
    const langBtnText = translations[currentLang].lang_btn;
    document.getElementById('lang-switch-desktop').innerText = langBtnText;
    document.getElementById('lang-switch-mobile').innerText = langBtnText;

    // Update body class for RTL
    if (currentLang === 'he') {
        document.body.classList.add('rtl');
        document.documentElement.setAttribute('lang', 'he');
    } else {
        document.body.classList.remove('rtl');
        document.documentElement.setAttribute('lang', 'en');
    }

    updateAuthUI();
};

const navSlide = () => {
    const burger = document.querySelector('.burger');
    const nav = document.querySelector('.nav-links');
    const navLinks = document.querySelectorAll('.nav-links li');
    const langSwitchDesktop = document.getElementById('lang-switch-desktop');
    const langSwitchMobile = document.getElementById('lang-switch-mobile');

    burger.addEventListener('click', () => {
        // Toggle Nav
        nav.classList.toggle('nav-active');

        // Animate Links
        navLinks.forEach((link, index) => {
            if (link.style.animation) {
                link.style.animation = '';
            } else {
                link.style.animation = `navLinkFade 0.5s ease forwards ${index / 7 + 0.3}s`;
            }
        });

        // Burger Animation
        burger.classList.toggle('toggle');
    });

    const toggleLang = (e) => {
        e.preventDefault();
        currentLang = currentLang === 'en' ? 'he' : 'en';
        updateLanguage();
    };

    if (langSwitchDesktop) langSwitchDesktop.addEventListener('click', toggleLang);
    if (langSwitchMobile) langSwitchMobile.addEventListener('click', toggleLang);
}

const scrollAnimations = () => {
    const observerOptions = {
        threshold: 0.2
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('active');
            }
        });
    }, observerOptions);

    const animatedElements = document.querySelectorAll('.animate-on-scroll');
    animatedElements.forEach(el => observer.observe(el));
};

/* Cart Logic */
let cart = JSON.parse(localStorage.getItem('cart')) || [];
let isDelivery = false;

/* EmailJS Initialization */
// REPLACE THESE WITH YOUR ACTUAL KEYS FROM EMAILJS.COM
const SERVICE_ID = "service_qnztk6h";
const TEMPLATE_ID = "template_yv9btwr";
const PUBLIC_KEY = "FXlsl4AhvCVg7uCeD";

(function () {
    emailjs.init(PUBLIC_KEY);
})();

const toggleCart = () => {
    document.getElementById('cart-sidebar').classList.toggle('active');
};

const updateCartTotal = () => {
    const deliveryRadio = document.querySelector('input[name="delivery"]:checked');
    isDelivery = deliveryRadio ? deliveryRadio.value === 'shipping' : false;
    updateCartUI();
};

const updateCartUI = () => {
    const cartItemsContainer = document.getElementById('cart-items');
    const cartCount = document.querySelector('.cart-count');
    const cartTotal = document.getElementById('cart-total');

    // Update Count
    cartCount.innerText = cart.length;

    // Calculate Total
    let subtotal = cart.reduce((acc, item) => {
        const priceStr = translations[currentLang][item.priceKey] || item.price;
        return acc + parseInt(priceStr.replace(/[^\d]/g, ''));
    }, 0);
    let total = isDelivery ? subtotal + 60 : subtotal;

    cartTotal.innerText = `₪${total}`;

    // Render Items
    cartItemsContainer.innerHTML = '';
    if (cart.length === 0) {
        cartItemsContainer.innerHTML = `<p class="empty-cart-msg" data-i18n="empty_cart">${translations[currentLang].empty_cart}</p>`;
    } else {
        cart.forEach((item, index) => {
            const displayName = translations[currentLang][item.nameKey] || item.name;
            const displayPrice = translations[currentLang][item.priceKey] || item.price;
            const itemHTML = `
                <div class="cart-item">
                    <div style="display:flex; align-items:center;">
                        <div style="width:50px; height:50px; background: #333; border-radius:5px; margin-right:10px; display:flex; justify-content:center; align-items:center; color:#555;">
                            <i class="fas fa-wine-bottle"></i>
                        </div>
                        <div class="cart-item-details">
                            <h4>${displayName}</h4>
                            <span>${displayPrice}</span>
                        </div>
                    </div>
                    <i class="fas fa-trash-alt remove-item" onclick="removeFromCart(${index})"></i>
                </div>
            `;
            cartItemsContainer.innerHTML += itemHTML;
        });
    }

    // Save to LocalStorage
    localStorage.setItem('cart', JSON.stringify(cart));
};

const addToCart = (nameKey, priceKey) => {
    const name = translations[currentLang][nameKey];
    const price = translations[currentLang][priceKey];

    cart.push({ name, price, nameKey, priceKey });
    updateCartUI();

    document.getElementById('cart-sidebar').classList.add('active');
};

const removeFromCart = (index) => {
    cart.splice(index, 1);
    updateCartUI();
};

/* PayPal Initialization */
const initPayPal = () => {
    if (!window.paypal) return;

    paypal.Buttons({
        createOrder: (data, actions) => {
            let subtotal = cart.reduce((acc, item) => acc + parseInt(item.price.replace(/[^\d]/g, '')), 0);
            let shipping = isDelivery ? 60 : 0;
            let total = subtotal + shipping;

            if (total === 0) return actions.reject();

            // Create items array for PayPal
            const paypalItems = cart.map(item => ({
                name: item.name,
                unit_amount: {
                    currency_code: 'ILS',
                    value: item.price.replace(/[^\d]/g, '')
                },
                quantity: '1'
            }));

            return actions.order.create({
                purchase_units: [{
                    amount: {
                        currency_code: 'ILS',
                        value: total.toString(),
                        breakdown: {
                            item_total: {
                                currency_code: 'ILS',
                                value: subtotal.toString()
                            },
                            shipping: {
                                currency_code: 'ILS',
                                value: shipping.toString()
                            }
                        }
                    },
                    items: paypalItems
                }]
            });
        },
        onApprove: (data, actions) => {
            return actions.order.capture().then((details) => {
                // Prepare Email Params
                const shippingAddress = details.purchase_units[0].shipping.address;
                const addressString = `${shippingAddress.address_line_1}, ${shippingAddress.admin_area_2}, ${shippingAddress.admin_area_1}, ${shippingAddress.postal_code}, ${shippingAddress.country_code}`;

                const subtotal = cart.reduce((acc, item) => acc + parseInt(item.price.replace(/[^\d]/g, '')), 0);
                const shipping = isDelivery ? 60 : 0;

                const emailParams = {
                    order_id: details.id,
                    customer_name: details.payer.name.given_name + ' ' + details.payer.name.surname,
                    email: details.payer.email_address,
                    delivery_method: isDelivery ? (translations[currentLang].shipping || "Delivery") : (translations[currentLang].pickup || "Self Pickup"),
                    shipping_address: isDelivery ? addressString : "N/A (Pickup)",
                    items_list: cart.map(i => `${i.name} (x1)`).join("<br>"),
                    cost_shipping: shipping,
                    cost_total: details.purchase_units[0].amount.value,
                    subtotal: subtotal
                };

                // Send Email
                emailjs.send(SERVICE_ID, TEMPLATE_ID, emailParams)
                    .then(function (response) {
                        console.log('SUCCESS!', response.status, response.text);
                        alert(`Transaction completed! Confirmation sent using EmailJS.`);
                    }, function (error) {
                        console.log('FAILED...', error);
                        alert('Transaction completed, but email failed to send (Check Console).');
                    });

                // Clear Cart
                cart = [];
                updateCartUI();
                toggleCart();
            });
        },
        onError: (err) => {
            console.error('PayPal Error:', err);
            alert('Something went wrong with the payment. Please try again.');
        }
    }).render('#paypal-button-container');
};

document.addEventListener('DOMContentLoaded', () => {
    navSlide();
    scrollAnimations();
    updateCartUI();
    initPayPal();

    // Attach Event Listeners to "Add to Cart" Buttons
    // Note: In a real app, products would have IDs. Here mapping via index for simplicity
    const addBtns = document.querySelectorAll('.btn-shop');
    const products = [
        { name: 'prod_1_name', price: 'prod_1_price' },
        { name: 'prod_2_name', price: 'prod_2_price' },
        { name: 'prod_3_name', price: 'prod_3_price' }
    ];

    addBtns.forEach((btn, index) => {
        btn.onclick = () => addToCart(products[index].name, products[index].price);
    });

    initAuth();
});

/* Authentication Logic */
let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
let resetEmail = null;

const initAuth = () => {
    const authLink = document.getElementById('auth-link');
    const authLinkMobile = document.getElementById('auth-link-mobile');
    const modal = document.getElementById('auth-modal');
    const closeBtn = document.querySelector('.close-modal');

    const toggleAuth = (e) => {
        e.preventDefault();
        if (currentUser) {
            handleLogout();
        } else {
            showModal('login-form');
        }
    };

    if (authLink) authLink.onclick = toggleAuth;
    if (authLinkMobile) authLinkMobile.onclick = toggleAuth;

    if (closeBtn) {
        closeBtn.onclick = () => modal.classList.remove('active');
    }

    window.onclick = (event) => {
        if (event.target == modal) {
            modal.classList.remove('active');
        }
    };

    updateAuthUI();
    checkResetToken();
};

const updateAuthUI = () => {
    const authLink = document.getElementById('auth-link');
    if (authLink) {
        if (currentUser) {
            const helloStr = translations[currentLang].hello || "Hello";
            const logoutStr = translations[currentLang].logout || "Logout";
            authLink.innerHTML = `${helloStr}, ${currentUser.name.split(' ')[0]} | <span style="text-decoration: underline;">${logoutStr}</span>`;
            authLink.setAttribute('data-i18n', ''); // Disable i18n for dynamic text
        } else {
            authLink.setAttribute('data-i18n', 'login_signup');
            authLink.innerText = translations[currentLang].login_signup;
        }
    }
};

const showModal = (formId) => {
    const modal = document.getElementById('auth-modal');
    const forms = ['login-form', 'signup-form', 'forgot-password-form', 'reset-password-form'];

    // Clear all inputs when switching forms
    const inputs = modal.querySelectorAll('input');
    inputs.forEach(input => input.value = '');

    forms.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = id === formId ? 'block' : 'none';
    });

    modal.classList.add('active');
};

const showLogin = () => showModal('login-form');
const showSignUp = () => showModal('signup-form');
const showForgotPassword = () => showModal('forgot-password-form');

const handleSignUp = (e) => {
    e.preventDefault();
    const name = document.getElementById('signup-name').value;
    const email = document.getElementById('signup-email').value.toLowerCase();
    const password = document.getElementById('signup-password').value;

    let users = JSON.parse(localStorage.getItem('users')) || [];
    if (users.find(u => u.email === email)) {
        alert(currentLang === 'he' ? "האימייל כבר קיים במערכת" : "Email already exists");
        return;
    }

    const newUser = { name, email, password };
    users.push(newUser);
    localStorage.setItem('users', JSON.stringify(users));

    currentUser = newUser;
    localStorage.setItem('currentUser', JSON.stringify(currentUser));

    document.getElementById('auth-modal').classList.remove('active');
    updateAuthUI();
    alert(currentLang === 'he' ? "נרשמת בהצלחה!" : "Signed up successfully!");
};

const handleLogin = (e) => {
    e.preventDefault();
    const email = document.getElementById('login-email').value.toLowerCase();
    const password = document.getElementById('login-password').value;

    const users = JSON.parse(localStorage.getItem('users')) || [];
    const user = users.find(u => u.email === email && u.password === password);

    if (user) {
        currentUser = user;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        document.getElementById('auth-modal').classList.remove('active');
        updateAuthUI();
    } else {
        alert(currentLang === 'he' ? "אימייל או סיסמה שגויים" : "Invalid email or password");
    }
};

const handleLogout = () => {
    currentUser = null;
    localStorage.removeItem('currentUser');
    updateAuthUI();
};

const handleForgotPassword = (e) => {
    e.preventDefault();
    const email = document.getElementById('forgot-email').value.toLowerCase();
    const users = JSON.parse(localStorage.getItem('users')) || [];
    const user = users.find(u => u.email === email);

    if (!user) {
        alert(currentLang === 'he' ? "אימייל לא נמצא" : "Email not found");
        return;
    }

    // Generate a unique token
    const token = Math.random().toString(36).substring(2) + Date.now().toString(36);
    const resetLink = `${window.location.origin}${window.location.pathname}#reset_token=${token}`;

    // Store token in localStorage with 1 hour expiry
    const resetData = {
        email: email,
        expiry: Date.now() + 3600000 // 1 hour
    };
    localStorage.setItem(`reset_${token}`, JSON.stringify(resetData));

    const templateParams = {
        email: email,
        link: resetLink
    };

    // Use the Template ID for the new HTML email template
    emailjs.send(SERVICE_ID, 'template_09ohb2s', templateParams)
        .then(() => {
            alert(currentLang === 'he' ? "לינק לאיפוס סיסמה נשלח למייל שלך" : "Password reset link has been sent to your email.");
            document.getElementById('auth-modal').classList.remove('active');
        }, (error) => {
            console.error("FAILED to send Reset Link", error);
            alert("Failed to send link. Please try again later.");
        });
};

const checkResetToken = () => {
    const hash = window.location.hash;
    if (hash.includes('reset_token=')) {
        const token = hash.split('reset_token=')[1].split('&')[0];
        const resetData = JSON.parse(localStorage.getItem(`reset_${token}`));

        if (resetData && resetData.expiry > Date.now()) {
            resetEmail = resetData.email;
            // Remove token immediately after use or keep it until actual reset?
            // For better UX, we'll keep it until the button is clicked.
            showModal('reset-password-form');
            // Clean up hash
            window.history.replaceState(null, null, window.location.pathname);
            localStorage.removeItem(`reset_${token}`);
        } else {
            alert(currentLang === 'he' ? "הלינק פג תוקף או שאינו תקין" : "Reset link is invalid or expired.");
            window.history.replaceState(null, null, window.location.pathname);
        }
    }
};

const handleResetPassword = (e) => {
    e.preventDefault();
    const newPassword = document.getElementById('new-password').value;

    let users = JSON.parse(localStorage.getItem('users')) || [];
    const userIndex = users.findIndex(u => u.email === resetEmail);

    if (userIndex !== -1) {
        users[userIndex].password = newPassword;
        localStorage.setItem('users', JSON.stringify(users));

        alert(currentLang === 'he' ? "הסיסמה שונתה בהצלחה! כעת ניתן להתחבר." : "Password reset successfully! You can now login.");
        resetEmail = null;
        showLogin();
    }
};
